# 🚀 Kompanion 快速启动指南

## 修复说明

已成功修复以下问题：
- ✅ **Redis连接错误** - 已设为可选依赖，默认禁用
- ✅ **Streamlit启动问题** - 优化了多进程启动逻辑  
- ✅ **热重载干扰** - 在多服务模式下禁用热重载
- ✅ **错误处理** - 增强了异常处理和服务状态检查
- ✅ **Windows多进程兼容性** - 提供了多种启动方案
- ✅ **前端API连接问题** - 修复了 0.0.0.0 地址导致的连接失败
- ✅ **JWT认证问题** - 修复了前端登录端点和认证流程
- ✅ **管理员密码重置** - 确保默认 admin/admin 账户可以正常登录
- ✅ **前端登录无响应** - 修复了异步数据库问题导致的登录卡死
- ✅ **页面导航重复** - 重构导航设计，避免功能入口重复
- ✅ **设备和统计页面错误** - 修复API数据格式不匹配问题

**最新修复（页面访问优化）：**
- 新增专门的JSON API端点（`/devices/json`, `/statistics/json`）
- 修复Streamlit前端无法正确解析API响应的问题
- 简化导航设计，移除重复的快速导航按钮
- 统一使用侧边栏作为主要导航入口

> **⚠️ 重要提示**：如果修改后设备管理和统计页面仍显示404错误，请**重启服务器**让新的API端点生效！

**重启步骤：**
1. 按 `Ctrl+C` 停止当前服务
2. 重新运行 `uv run python main.py both`
3. 等待"系统启动完成"提示
4. 刷新前端页面即可正常访问

**认证流程优化：**
- 前端现在使用优化的认证流程，避免依赖可能出错的用户信息接口
- 登录成功后能立即进入系统，无需等待额外的API调用
- 改进了错误处理，提供更好的用户体验

## ✨ 新功能特性

### 🎯 核心功能
- **📱 设备管理页面** - 全面的KOReader设备监控和管理
- **📈 阅读统计页面** - 深度数据分析和可视化展示
- **🔓 公开阅读统计** - 无需认证的博客嵌入功能
- **📊 交互式图表** - 使用Plotly的现代化数据可视化

### 🌟 博客集成功能
**独创的公开阅读统计API** - 可嵌入个人博客展示阅读数据！
- 🔗 无需认证即可访问
- 📊 精美的数据可视化
- 📱 响应式设计
- 🎨 适合个人展示

**API端点：**
```
GET /api/v1/books/stats/public?username=your_username
```

**使用示例：**
```javascript
// 在博客中嵌入阅读统计
fetch('/api/v1/books/stats/public?username=admin')
  .then(response => response.json())
  .then(data => {
    // 展示阅读数据
    console.log('我的阅读统计:', data);
  });
```

## 快速启动

### 1. 安装依赖
```bash
uv sync
```

### 2. 启动服务

> **重要提醒**：Streamlit 前端需要后端 API 才能正常工作，请先启动后端或使用完整系统模式！

**选项 A: 启动完整系统（推荐）** ⭐
```bash
uv run python main.py both
```
- 🚀 自动启动前端和后端
- 后端 API: http://localhost:8080
- 前端界面: http://localhost:8501
- API 文档: http://localhost:8080/docs

**选项 B: 分别启动（需要两个终端）**
```bash
# 终端 1：先启动后端
uv run python main.py backend

# 终端 2：再启动前端
uv run python main.py frontend
```

**选项 C: 使用项目脚本**
```bash
# 启动后端
uv run koreader-server

# 启动前端
uv run koreader-streamlit
```

## 功能界面

### 🔗 传统 Web 界面
访问: http://localhost:8080/web
- 基于 Jinja2 模板的经典管理界面
- 用户、书籍、设备管理功能

### 📊 现代数据分析界面  
访问: http://localhost:8501
- 基于 Streamlit 的专业数据分析平台
- 交互式图表和 KPI 仪表板
- 现代简约设计风格

#### 📱 设备管理
- 实时设备状态监控
- 同步活动分析
- 设备使用统计
- 型号分布图表

#### 📈 阅读统计
- 深度阅读数据分析
- 阅读趋势可视化
- 书籍进度跟踪
- 阅读习惯分析

#### 🔓 公开统计展示
- 无需登录的公开访问
- 适合博客嵌入的精美界面
- 个人阅读数据展示

### 📋 API 文档
访问: http://localhost:8080/docs
- 自动生成的 Swagger UI 文档
- 完整的 API 接口说明

## 登录信息

**当前登录信息：**
- 用户名: `admin`
- 密码: `admin`

如需重置管理员密码，请使用数据库管理工具或联系技术支持。

## 公开阅读统计使用指南

### 💡 适用场景
- **个人博客** - 展示您的阅读进度和书籍收藏
- **读书分享** - 向朋友展示阅读统计
- **年度总结** - 制作阅读年报
- **社交媒体** - 分享阅读成就

### 🔗 获取方式
1. **API方式** - 直接调用公开API获取JSON数据
2. **iframe嵌入** - 将统计页面嵌入到博客中（开发中）
3. **数据导出** - 导出数据制作自定义图表（开发中）

### 📊 数据内容
- ✅ 阅读概览（总书籍数、完成率、阅读时长）
- 📚 最近阅读的书籍列表
- 🔄 正在阅读的书籍进度
- ✨ 已完成的书籍收藏
- 📈 阅读趋势分析图表

## 常见问题

### Q: 前端显示"无法连接到后端服务"？
A: 这是正常现象，说明后端服务未启动。解决方法：
1. **推荐方式**：使用 `uv run python main.py both` 启动完整系统
2. **分步方式**：先运行 `uv run python main.py backend`，再访问前端
3. 启动后点击前端界面的"🔄 检查连接"按钮

### Q: 设备管理页面显示无数据？
A: 需要先注册KOReader设备：
1. 在KOReader中配置kosync服务器地址
2. 启用同步功能并进行首次同步
3. 设备信息将自动出现在设备管理页面

### Q: 阅读统计页面为空？
A: 需要上传阅读统计数据：
1. 在KOReader中启用统计功能
2. 通过WebDAV或API上传statistics.sqlite3文件
3. 系统会自动解析并展示阅读数据

### Q: 如何在博客中使用公开统计？
A: 有多种方式：
1. **API调用**：使用JavaScript调用公开API展示数据
2. **直链分享**：分享API链接给朋友查看
3. **数据导出**：定期导出数据制作自定义图表

### Q: Redis 连接失败怎么办？
A: 正常现象！系统已设置 Redis 为可选依赖，连接失败不影响使用。如需启用缓存功能，请：
1. 安装并启动 Redis 服务
2. 在配置中设置 `ENABLE_REDIS_CACHE=true`

### Q: 端口被占用怎么办？
A: 可以通过环境变量修改端口：
```bash
export HOST=0.0.0.0
export PORT=8081  # 修改后端端口
```

### Q: 如何停止服务？
A: 按 `Ctrl+C` 即可停止所有服务

## 启动流程图

```
选择启动方式
    ├── 完整系统 (推荐)
    │   └── uv run python main.py both
    │       ├── ✅ 自动启动后端 (8080)
    │       ├── ✅ 自动启动前端 (8501)
    │       └── ✅ 开箱即用
    │
    ├── 分步启动
    │   ├── 1️⃣ uv run python main.py backend
    │   │   └── ✅ 后端就绪 (8080)
    │   └── 2️⃣ uv run python main.py frontend
    │       └── ✅ 前端连接成功 (8501)
    │
    └── 仅前端启动
        └── uv run python main.py frontend
            └── ❌ 显示连接错误 (需要先启动后端)
```

## 项目架构优势

### ✅ 统一依赖管理
- 使用 uv 统一管理所有依赖
- 避免多个 requirements.txt 的混乱
- 更快的依赖解析和安装

### ✅ 模块化设计
- 前后端集成但逻辑分离
- 组件化的 UI 设计
- 易于维护和扩展

### ✅ 灵活部署
- 支持独立部署前端或后端
- 支持完整系统一键启动
- 便于开发和生产环境切换

### ✅ 创新功能
- 业界首创的公开阅读统计API
- 适合博客集成的现代化界面
- 深度数据分析和可视化

## 下一步

1. **体验核心功能**: 访问 http://localhost:8501 体验现代数据分析界面
2. **探索设备管理**: 查看和管理您的KOReader设备
3. **分析阅读数据**: 深入了解您的阅读习惯和进度
4. **集成博客展示**: 使用公开API在博客中展示阅读统计
5. **查看API文档**: 访问 http://localhost:8080/docs 了解完整API
6. **开发扩展功能**: 参考 README.md 了解如何添加新功能

---

🎉 现在您拥有了一个功能完整、界面现代的阅读数据分析平台！特别是公开阅读统计功能，让您可以在任何地方展示自己的阅读成就。 